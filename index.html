<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pk Movies</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
       
     body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a1a, #101020);
            color: #fff;
            margin: 0;
            padding: 0 0 60px 0; 
        }

        .header {
            background-color: #0d0d1a;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; 
            top: 0;
            z-index: 30;
        }

        .header h1 {
            margin: 0;
            padding: 0;
            background: linear-gradient(90deg, #ff4d4d, #ff8c1a);
            -webkit-background-clip: text;
            color: transparent;
            font-size: 32px;
            cursor: pointer; 
        }

       #searchBar {
            padding: 8px 1px;
            border: 1px solid #ff8c1a;
            border-radius: 1px;
            background-color: #2a2a2a;
            color: #fff;
            width: 200px;
            outline: none;
        }
        #searchBar:focus {
            width: 200px;
        }

       .movie-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 15px;
        padding: 20px;
        }
        
        @media (max-width: 600px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            #searchBar {
                width: 100%;
                margin-top: 10px;
            }
            .movie-grid {
                grid-template-columns: 1fr; 
            }
            .categories-content {
                max-width: 100%; 
                margin: 0;
                height: auto; 
                border-radius: 0;
                padding: 20px 10px;
            }
            #categoriesOverlay {
                padding: 0;
            }
        }
        
        /* MOVIE CARD STYLES */
        .movie-card {
            background: #1f1f2e; 
            border-radius: 2px; 
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5); 
            border: 1px solid #333;
        }

        .movie-card:hover {  
            transform: translateY(-5px) scale(1.02); 
            border-color: #ff4d4d;  
            box-shadow: 0 10px 25px rgba(255, 77, 77, 0.4);   
        }  

        .movie-card img {  
            width: 100%;  
            aspect-ratio: 3/4;   
            object-fit: cover;   
            background-color: #000;   
            flex-shrink: 0;   
            border-top-left-radius: 2px; 
            border-top-right-radius: 2px;  
        }  

        .movie-card p {  
            padding: 10px 10px 5px 10px; 
            text-align: left; 
            font-size: 18px; 
            font-weight: 900; 
            color: #fff;  
            margin: 0;  
            white-space: nowrap;  
            overflow: hidden;  
            text-overflow: ellipsis; 
        }  
          
        .category-badge {  
            background: none;   
            color: #ff8c1a; 
            padding: 0 10px 10px 10px; 
            border-radius: 0;  
            font-size: 12px;   
            font-weight: bold;  
            display: block; 
            text-align: left;  
        }


        /* Pagination & Loading Spinner Styles */
        .pagination-controls { display: flex; justify-content: center; gap: 20px; padding: 20px; }
        .page-btn { background: #ff4d4d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
        .page-btn:hover:not(:disabled) { background: #cc0000; }
        .page-btn:disabled { background: #444; cursor: not-allowed; color: #888; }
        #loadingSpinner { display: none; text-align: center; padding: 50px; }
        .spinner { border: 8px solid #333; border-top: 8px solid #ff8c1a; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


        /* MOVIE DETAIL POPUP styles (CRUCIAL: Scrollable Modal) */
        .movie-detail { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(3px); 
            padding: 20px; 
            overflow-y: auto; 
            z-index: 40; 
        }
        .detail-content { 
            max-width: 600px; 
            margin: 50px auto; 
            background: #2a2a2a; 
            padding: 20px; 
            border-radius: 12px; 
            position: relative; 
            animation: pop 0.3s ease; 
        }
        @keyframes pop { 0% { transform: scale(0.7); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* Close button styling and positioning */
        .detail-close-top { 
            position: absolute; 
            top: 5px; 
            left: 50%;
            transform: translateX(-50%); 
            background: #ff0033; 
            color: #fff; 
            padding: 8px 15px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 14px; 
            z-index: 999; 
            transition: background 0.2s;
        }
        .detail-close-top:hover {
            background: #cc002a;
        }

        /* Player Container Style */
        #inModalPlayerContainer {
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
            margin-top: 40px; 
            margin-bottom: 20px;
            display: none; 
            border: 1px solid #ff8c1a;
            position: relative;
        }

        #inModalPlayerContainer video {
            width: 100%;
            height: auto;
            max-height: 400px; 
        }
        
        .detail-content img { 
            width: 100%; 
            border-radius: 10px; 
            margin-top: 0px; 
        }
        
        
        /* Buttons */
        .btn-box { 
            display: flex; 
            gap: 10px; 
            margin-top: 20px; 
            flex-wrap: wrap; 
        }
        .btn { 
            flex: 1; 
            padding: 12px; 
            background: #ff9800; 
            color: #000; 
            border-radius: 8px; 
            text-align: center; 
            font-weight: bold; 
            cursor: pointer; 
            text-decoration: none; 
            transition: 0.2s;
            min-width: 120px; 
        }
        .btn:hover { background: #ffc266; }
        
        /* Style for Favorite Button */
        #favoriteBtn {
            background: #e91e63; 
            color: white;
            font-size: 14px;
        }
        #favoriteBtn.added {
            background: #00e676; 
        }
        #favoriteBtn:hover {
             background: #c2185b;
        }

        /* New Download Links Button Style */
        #otherDownloadBtn { 
            display: block;
            width: 100%; 
            margin-top: 10px;
            padding: 8px 12px;
            background: #3f51b5;
            color: white;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        #otherDownloadBtn:hover {
            background: #303f9f;
        }
        
        /* Info Box for Genres/Year/Rating */
        #modalInfo {
            margin-top: 15px;
            padding: 10px;
            background-color: #333;
            border-radius: 8px;
            font-size: 14px;
        }
        #modalInfo span {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #ffc107;
        }
         /* ðŸ†• NEW Rating Badge */
        .rating-badge {
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: bold;
            margin-left: 10px;
            display: inline-block;
        }


        /* Episode List Specific Styles */
        #episodeList {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background-color: #333;
        }
        .episode-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #444;
        }
        .episode-item:last-child {
            border-bottom: none;
        }
        .ep-title {
            color: #ddd;
            font-size: 16px;
            flex-grow: 1; 
        }
        .ep-actions {
             display: flex;
             gap: 10px;
        }
        .ep-play-btn, .ep-download-btn {
            background: #00bcd4;
            color: white;
            padding: 6px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
            text-decoration: none; 
            display: inline-block;
        }
        .ep-play-btn:hover { background: #0097a7; }
        .ep-download-btn { background: #4caf50; }
        .ep-download-btn:hover { background: #388e3c; }


        /* Ad Pop-up Styles */
        #adPopup { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.95); display: none; justify-content: center; align-items: center; z-index: 100000; padding: 20px; }
        #adIframeContainer { width: 90%; height: 90%; max-width: 900px; max-height: 700px; position: relative; }
        #adIframe { width: 100%; height: 100%; border: none; }
        #adTimer { position: absolute; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.7); color: white; padding: 5px 10px; border-radius: 5px; font-size: 18px; z-index: 100001; }
        
        /* Fixed Bottom Navigation Bar Styles */
        #bottomNav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: #1e1e2d;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 50; 
            border-top: 2px solid #ff8c1a;
        }
        .nav-item-btn {
            color: #aaa;
            text-align: center;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s, transform 0.2s;
            flex-grow: 1;
        }
        .nav-item-btn:hover {
            color: #fff;
        }
        .nav-item-btn.active {
            color: #ff8c1a;
            transform: scale(1.1);
        }
        .nav-item-btn i {
            font-size: 20px;
            display: block;
            margin-bottom: 2px;
        }
        .nav-item-btn span {
            font-size: 12px;
            font-weight: bold;
        }
        
        /* Categories Overlay Pop-up */
        #categoriesOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 70;
            padding: 20px;
            overflow-y: auto;
        }
        .categories-content {
            max-width: 800px; 
            width: 90%; 
            margin: 50px auto;
            background: #2a2a2a;
            padding: 20px;
            border-radius: 12px;
            position: relative;
            animation: pop 0.3s ease;
        }
        .categories-content h2 {
            color: #ff8c1a;
            text-align: center;
            border-bottom: 2px solid #ff8c1a;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .category-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            text-align: center;
        }
        .category-item-btn {
            background: #444;
            color: white;
            padding: 15px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s, transform 0.2s;
            font-size: 10px;
        }
        .category-item-btn:hover {
            background: #ff4d4d;
            transform: translateY(-3px);
        }
    </style>
</head>

<body> 
<div class="header" id="pageHeader">
    <h1 onclick="loadAllMovies()">Pk Movies</h1> <input type="text" id="searchBar" onkeyup="debounceFilter()" placeholder="Search Movie...">
</div>


<div id="loadingSpinner">
    <div class="spinner"></div>
    <p>Loading...</p>
</div>

<div id="movieGrid" class="movie-grid"></div>

<div class="pagination-controls">
    <button id="prevBtn" class="page-btn" onclick="goToPage(-1)">Previous</button>
    <button id="nextBtn" class="page-btn" onclick="goToPage(1)">Next</button>
</div>

<div id="modal" class="movie-detail">
    <div class="detail-content">

        <div class="detail-close-top" onclick="closeDetail()">Close</div>
        
        <div id="inModalPlayerContainer">
            <video 
                id="inModalVideoPlayer"
                controls
                autoplay
                playsinline
                preload="auto">
                <source id="inModalVideoSource" src="#">
            </video>
        </div>
        <img id="modalImg" src="">
        
        <h2 id="modalTitle"></h2>
        <div id="modalInfo">
           <span id="modalYear">Year: N/A</span>
            <span id="modalRating"><i class="fas fa-star" style="color: #ffc107;"></i>Rating: N/A</span>
            <span id="modalGenres">Genres: N/A</span>
        </div>
        <p id="modalDesc"></p>

        <div id="seriesEpisodeContainer" style="display: none;">
            <h3>Episodes:</h3>
             <label for="seasonSelect" style="display: block; margin-top: 10px;">Select Season:</label>
            <select id="seasonSelect" onchange="displaySeasonEpisodes(this.value)" style="width: 100%; padding: 8px; margin-bottom: 10px;"></select>
            
            <div id="episodeList">
            </div>
        </div>
        
        <div id="movieLinksContainer" style="display: none;">
            <div class="btn-box">
                <button id="favoriteBtn" class="btn" data-key=""> Add to Favorites</button>
                <button id="playBtn" class="btn">Play Movie</button>
                <button id="downloadBtn" class="btn">Download</button> 
            </div>
            <button id="otherDownloadBtn" style="display: none;" onclick="openOtherDownloadLinks()">
                <i class="fas fa-link"></i> Other Download Links
            </button>
        </div>
    </div>
</div>

<div id="adPopup">
    <div id="adIframeContainer">
        <span id="adTimer">0</span>
        <iframe id="adIframe"></iframe>
    </div>
</div>


<div id="bottomNav">
    <div class="nav-item-btn active" data-target="all" onclick="handleNavClick('all', this)">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </div>
    <div class="nav-item-btn" data-target="categories" onclick="showCategoriesOverlay(this)">
        <i class="fas fa-tags"></i>
        <span>Categories</span>
    </div>
    <div class="nav-item-btn" data-target="movie" onclick="handleNavClick('movie', this)">
        <i class="fas fa-film"></i>
        <span>Movies</span>
    </div>
    <div class="nav-item-btn" data-target="series" onclick="handleNavClick('series', this)">
        <i class="fas fa-tv"></i>
        <span>Web Series</span>
    </div>
    <div class="nav-item-btn" data-target="popular" onclick="handleNavClick('popular', this)">
        <i class="fas fa-star"></i>
        <span>Popular</span>
    </div>
    <div class="nav-item-btn" data-target="favorites" onclick="handleNavClick('favorites', this)">
        <i class="fas fa-heart"></i>
        <span>Favorites</span>
    </div>
</div>

<div id="categoriesOverlay" onclick="if(event.target.id === 'categoriesOverlay') closeCategoriesOverlay()">
    <div class="categories-content">
        <h2>Select Category</h2>
        <div id="categoryListOverlay" class="category-list">
            <p style="text-align: center; color:#ccc;">Loading categories...</p>
        </div>
    </div>
</div>


<script>
    // 2. Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAJV7KSXkJ4E_p9Aa6iS84d0sqww1Fj6O0",
        authDomain: "watcherzone.firebaseapp.com",
        databaseURL: "https://watcherzone-default-rtdb.firebaseio.com",
        projectId: "watcherzone",
        storageBucket: "watcherzone.firebasestorage.app",
        messagingSenderId: "230041708754",
        appId: "1:230041708754:web:88044026d1eb142a73e50b"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const moviesRef = database.ref('movies'); 
    const popularRef = database.ref('popular_movies'); // ðŸ†• NEW REF
    const categoryRef = database.ref('categories'); 

    const grid = document.getElementById("movieGrid");
    const spinner = document.getElementById("loadingSpinner");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const paginationControls = document.querySelector('.pagination-controls');
    const searchBar = document.getElementById('searchBar');
    
    // Pagination Variables
    const MOVIES_PER_PAGE = 10;
    let allContent = []; // Merged array for all movies/series from 'movies' ref AND 'popular_movies' ref
    let popularContent = []; // Separate array for popular content (for popular tab)
    let filteredMovies = []; 
    let currentFilterType = 'all'; 
    let currentPage = 1;
    let totalPages = 1;
    
    let searchTimeout = null; 

    // Ad Links Array (Unchanged)
    const adLinks = [
        "https://www.effectivegatecpm.com/yz4z5szmf?key=73186bcddd33133e4b3c585292f10bde",
        "https://www.effectivegatecpm.com/s2mq62in?key=b17a7185381af8ce5baa404d8817d708",
        "https://www.effectivegatecpm.com/cm2npj3b6n?key=bbdca23bff7d7d54853f830d7c238ddf",
        "https://www.effectivegatecpm.com/uyz2avfp?key=af05da8c47fc0d441624224a14c722a6",
        "https://www.effectivegatecpm.com/uz50mzu3f?key=efec633d14ae4a27a4a0aa1aa41c9c7e",
        "https://www.effectivegatecpm.com/uck9x0wk6?key=11fca88e86f0d00b67543ac7a783e47f",
        "https://www.effectivegatecpm.com/zq5rzngg?key=a6fd58330a330c83ef94c1f7b6534856",
        "https://www.effectivegatecpm.com/dqm7ya0myx?key=976aa4962ea641f87639dfc784b35969"
    ];

    function getRandomAdLink() {
        if (adLinks.length === 0) return '#';
        const randomIndex = Math.floor(Math.random() * adLinks.length);
        return adLinks[randomIndex];
    }
    
    const defaultCategories = {
        'Bollywood': 'Bollywood',
        'Hollywood': 'Hollywood',
        'SouthIndian': 'South Indian',
        'Punjabi': 'Punjabi',
        'Pakistani': 'Pakistani',
        'Other': 'Other'
    };
    
    let currentVideoUrl = null; 
    let currentDetailData = null; 
    let currentDetailMovieKey = null; 

    // --- Universal Navigation Handler (Point 3) ---
    function handleNavClick(filter, element) {
         if (filter === 'categories') return; // Handled by showCategoriesOverlay

         // 1. Show loading spinner and clear grid
         spinner.style.display = 'block';
         grid.innerHTML = ''; 
         paginationControls.style.display = 'none';

         // 2. Remove active class from all and add to current
         document.querySelectorAll('.nav-item-btn').forEach(item => item.classList.remove('active'));
         if(element) element.classList.add('active');

         // 3. Clear search and close detail/overlay
         searchBar.value = '';
         clearTimeout(searchTimeout); 
         closeDetail();
         closeCategoriesOverlay();

         // 4. Set new filter and wait 500ms before rendering (for smooth animation)
         currentFilterType = filter;
         
         setTimeout(() => {
            setFilter(filter);

            // 5. Hide spinner and scroll to top
            spinner.style.display = 'none';
            document.getElementById("pageHeader").scrollIntoView({ behavior: 'smooth' });
         }, 500);
    }


    // --- Filter Logic (MODIFIED) ---
    
    function setFilter(filter) {
        if (filter === 'all') {
            // Use allContent, which now includes both standard and popular
            filteredMovies = [...allContent]; 
        } else if (filter === 'movie') {
            // Filter all content for movies (including popular ones that are movies)
            filteredMovies = allContent.filter(m => m.type === 'movie');
        } else if (filter === 'series') {
            // Filter all content for series (including popular ones that are series)
            filteredMovies = allContent.filter(m => m.type === 'series');
        } else if (filter === 'popular') { // ðŸ†• NEW Popular Filter
             // Only show content explicitly loaded as popular
             filteredMovies = popularContent;
        } else if (filter === 'favorites') { 
             filteredMovies = getFavoritesMovies();
        } 
        else {
            // Category filter - filter all content by category
            filteredMovies = allContent.filter(m => m.category === filter);
        }
        
        totalPages = Math.ceil(filteredMovies.length / MOVIES_PER_PAGE);
        currentPage = 1;
        renderPage(currentPage);
        
        // Show pagination only if filter is not search, has more than 1 page, and is not a category filter (Categories usually render all)
        if (totalPages > 1 && currentFilterType !== 'search' && !Object.values(defaultCategories).includes(currentFilterType)) { 
            paginationControls.style.display = 'flex';
        } else {
            paginationControls.style.display = 'none';
        }
    }
    
    // --- Render Page (Point 4 - Lazy Loading/Rendering) ---
    function renderPage(pageNumber) {
        const moviesArray = filteredMovies; 
        const start = (pageNumber - 1) * MOVIES_PER_PAGE;
        const end = start + MOVIES_PER_PAGE;
        const moviesToShow = moviesArray.slice(start, end); // Only render MOVIES_PER_PAGE items

        grid.innerHTML = '';
        
        if (moviesToShow.length === 0) {
             let message = '';
             if (currentFilterType === 'favorites') {
                message = `Your **Favorites** list is empty. Add a movie or series by clicking "Add to Favorites" in the detail screen.`;
             } else if (currentFilterType === 'search') {
                 message = `No results found for **${searchBar.value}**.`;
             }
             else {
                 const filterName = currentFilterType.charAt(0).toUpperCase() + currentFilterType.slice(1);
                 message = `No **${filterName}** content found.`;
             }
             grid.innerHTML = `<p style="text-align: center; width: 100%; color: #aaa;">${message}</p>`;
        } else {
            moviesToShow.forEach((movie) => {
                const categoryText = movie.category || 'Other'; 
                // Determine display type (Popular tag is now added to the type if present)
                let typeText = movie.type === 'series' ? 'Web Series' : 'Movie';
                if (movie.isPopular) {
                    typeText = `Popular / ${typeText}`;
                }
                
                grid.innerHTML += `
                    <div class="movie-card" onclick="openDetail('${movie.key}', '${movie.isPopular ? 'popular' : 'content'}')" data-title="${movie.title}" data-category="${categoryText}">
                        <img src="${movie.img}">
                        <p>${movie.title}</p>
                        <span class="category-badge">${categoryText} / ${typeText}</span> 
                    </div>
                `;
            });
        }

        prevBtn.disabled = pageNumber === 1;
        nextBtn.disabled = pageNumber === totalPages;
    }

    // ðŸ’¥ ØªØ¨Ø¯ÛŒÙ„ Ø´Ø¯Û ÙÙ†Ú©Ø´Ù†: goToPage (Point 3) ðŸ’¥
    function goToPage(direction) {
        const newPage = currentPage + direction;
        
        if (newPage >= 1 && newPage <= totalPages) {
            
            spinner.style.display = 'block';
            grid.innerHTML = ''; 

            setTimeout(() => {
                currentPage = newPage;
                renderPage(currentPage);
                
                spinner.style.display = 'none';

                // Scroll the page to the top
                document.getElementById("pageHeader").scrollIntoView({ behavior: 'smooth' });
            }, 500); // 0.5 second delay for animation effect
        }
    }


    // --- Favorites Logic (Unchanged) ---

    function getFavorites() {
        const favoritesJson = localStorage.getItem('pakMoviesFavorites');
        return favoritesJson ? JSON.parse(favoritesJson) : [];
    }

    function getFavoritesMovies() {
        const favoriteKeys = getFavorites();
        // Search in allContent (which includes popularContent now)
        return allContent.filter(movie => favoriteKeys.includes(movie.key));
    }

    function isFavorite(movieKey) {
        const favorites = getFavorites();
        return favorites.includes(movieKey);
    }

    function toggleFavorite(movieKey) {
        let favorites = getFavorites();
        const favoriteBtn = document.getElementById('favoriteBtn');
        
        if (favorites.includes(movieKey)) {
            favorites = favorites.filter(key => key !== movieKey);
            localStorage.setItem('pakMoviesFavorites', JSON.stringify(favorites));
            
            favoriteBtn.innerHTML = ' Add to Favorites';
            favoriteBtn.classList.remove('added');

        } else {
            favorites.push(movieKey);
            localStorage.setItem('pakMoviesFavorites', JSON.stringify(favorites));
            
            favoriteBtn.innerHTML = 'âœ… Added to Favorites';
            favoriteBtn.classList.add('added');
        }
    }

    // --- Detail and Play Functions (UPDATED) ---
    

    function openDetail(key, contentSource = 'content') {
        // Since allContent now holds everything, we just search there
        const m = allContent.find(movie => movie.key === key);

        if (!m) {
             return;
        } 
        currentDetailData = m;
        
        // 1. Hide the player first before showing details
        const playerContainer = document.getElementById("inModalPlayerContainer");
        playerContainer.style.display = 'none';
        
        // 2. Stop any existing video playback
        const video = document.getElementById("inModalVideoPlayer");
        if (!video.paused) {
            video.pause();
            video.removeAttribute('src'); 
            video.load();
        }

        currentDetailMovieKey = key; 

        document.getElementById("modalImg").src = currentDetailData.img;
        document.getElementById("modalTitle").innerText = currentDetailData.title;
        document.getElementById("modalDesc").innerText = currentDetailData.desc || ''; 
        
        // ðŸ†• NEW IMDb Rating Display
        const rating = currentDetailData.rating ? parseFloat(currentDetailData.rating).toFixed(1) : 'N/A';
        document.getElementById("modalRating").innerHTML = `<i class="fas fa-star" style="color: #ffc107;"></i>Rating: ${rating}`;
        document.getElementById("modalYear").innerText = `Year: ${currentDetailData.year || 'N/A'}`;
        document.getElementById("modalGenres").innerText = `Genres: ${currentDetailData.genres || 'N/A'}`;


        const movieLinksContainer = document.getElementById("movieLinksContainer");
        const seriesEpisodeContainer = document.getElementById("seriesEpisodeContainer");
        const favoriteBtn = document.getElementById("favoriteBtn"); 
        const downloadBtn = document.getElementById("downloadBtn"); 
        const playBtn = document.getElementById("playBtn"); 
        const seasonSelect = document.getElementById("seasonSelect"); 
        const otherDownloadBtn = document.getElementById('otherDownloadBtn'); 

        
        // Set up the Favorites button
        favoriteBtn.setAttribute('data-key', key);
        favoriteBtn.onclick = function() {
            toggleFavorite(key);
        };
        
        if (isFavorite(key)) {
            favoriteBtn.innerHTML = 'âœ… Added to Favorites';
            favoriteBtn.classList.add('added');
        } else {
            favoriteBtn.innerHTML = ' Add to Favorites';
            favoriteBtn.classList.remove('added');
        }

        // Setup the Other Download Button 
        if (currentDetailData.otherDownloadLink && currentDetailData.otherDownloadLink.trim() !== '' && currentDetailData.otherDownloadLink.trim() !== '#') {
            otherDownloadBtn.style.display = 'block';
        } else {
            otherDownloadBtn.style.display = 'none';
        }


        if (currentDetailData.type === 'series') {
            movieLinksContainer.style.display = 'block'; 
            seriesEpisodeContainer.style.display = 'block';

            playBtn.style.display = 'none'; 
            downloadBtn.style.display = 'none'; 
            
            favoriteBtn.style.order = 1;
            
            // Populate Season Dropdown
            const seasonsCount = currentDetailData.seasons || 1;
            seasonSelect.innerHTML = '';
            for (let i = 1; i <= seasonsCount; i++) {
                const option = document.createElement('option');
                const seasonKey = `S${i}`;
                option.value = seasonKey;
                option.innerText = `Season ${i}`;
                seasonSelect.appendChild(option);
            }
            
            // Check if episodes data exists before displaying
            const firstSeasonKey = 'S1';
            if (currentDetailData.episodes && currentDetailData.episodes[firstSeasonKey]) {
                displaySeasonEpisodes(firstSeasonKey); 
            } else {
                 document.getElementById("episodeList").innerHTML = `<p style="color: #ffc107;">No episodes found for this series.</p>`;
            }


        } else {
            seriesEpisodeContainer.style.display = 'none';
            movieLinksContainer.style.display = 'block'; 
            
            playBtn.style.display = 'inline-block';
            downloadBtn.style.display = 'inline-block'; 
            
            favoriteBtn.style.order = 3; 
            
            // Set up download button for movie
            downloadBtn.onclick = function() {
                showAdPopup(currentDetailData.download, 10, false); 
            };

            // Set up movie play button
            playBtn.onclick = function () {
                playMovie(currentDetailData.play, key);
            };
        }
        
        // 3. Show the detail modal
        document.getElementById("modal").style.display = "block";
    }

    // Function to display episodes based on selected season
    function displaySeasonEpisodes(seasonKey) {
        const episodeList = document.getElementById("episodeList");
        episodeList.innerHTML = '';
        
        if (!currentDetailData || !currentDetailData.episodes || !currentDetailData.episodes[seasonKey]) {
            episodeList.innerHTML = `<p style="color: #ffc107;">No episodes found for ${seasonKey}.</p>`;
            return;
        }

        const seasonEpisodes = currentDetailData.episodes[seasonKey];
        
        const episodeKeys = Object.keys(seasonEpisodes).sort((a, b) => {
             const numA = parseInt(a.replace('ep_', ''));
             const numB = parseInt(b.replace('ep_', ''));
             return numA - numB;
        });

        episodeKeys.forEach(epKey => {
            const episode = seasonEpisodes[epKey];
            const item = document.createElement('div');
            item.className = 'episode-item';
            item.innerHTML = `
                <span class="ep-title">${episode.title}</span>
                <div class="ep-actions">
                    <button class="ep-play-btn" onclick="playMovie('${episode.link}', '${currentDetailMovieKey + seasonKey + epKey}')">Play</button>
                    <button class="ep-download-btn" onclick="showAdPopup('${currentDetailData.download}', 10, false)">Download</button>
                </div>
            `;
            episodeList.appendChild(item);
        });
    }

    // NEW FUNCTION: Open Other Download Links
    function openOtherDownloadLinks() {
        if (currentDetailData && currentDetailData.otherDownloadLink) {
            window.open(currentDetailData.otherDownloadLink, '_blank');
        } else {
            alert("No other download link available.");
        }
    }


    function closeDetail() {
        // 1. Pause video and save progress
        const video = document.getElementById("inModalVideoPlayer");
        if (video && !video.paused && currentVideoUrl) {
            localStorage.setItem('videoProgress:' + currentVideoUrl, Math.floor(video.currentTime));
            video.pause();
            currentVideoUrl = null; 
        }
        
        // 2. Hide the modal
        document.getElementById("modal").style.display = "none";
        document.getElementById("inModalPlayerContainer").style.display = 'none'; 

        currentDetailMovieKey = null; 
        currentDetailData = null; 
    }
    
    // UPDATED VIDEO PLAYBACK FUNCTION
    function playMovie(url, key) {
        if (!url || url === '#') {
            console.error("Play link is not available.");
            return;
        }

        const playerContainer = document.getElementById("inModalPlayerContainer");
        const video = document.getElementById("inModalVideoPlayer");
        const source = document.getElementById("inModalVideoSource");
        const scrollContainer = document.getElementById("modal"); 
        
        video.pause();
        currentVideoUrl = key; 
        source.src = url;
        video.load();
        
        const savedTime = localStorage.getItem('videoProgress:' + key);
        if (savedTime) {
            video.currentTime = parseFloat(savedTime);
        } else {
            video.currentTime = 0;
        }

        playerContainer.style.display = "block";
        
        // Smoothly scroll the Pop-up container (#modal) to the top to show the player
        scrollContainer.scrollTo({
            top: 0, 
            behavior: 'smooth' 
        });

        video.play();
        
        video.ontimeupdate = function() {
            if (!video.paused && !video.ended) {
                 localStorage.setItem('videoProgress:' + key, Math.floor(video.currentTime)); 
            }
        };

        video.onloadeddata = function() {
            openVideoPlayerFullScreen();
        };
    }
    
    // Function for native fullscreen request (Unchanged)
    function openVideoPlayerFullScreen() {
        const video = document.getElementById("inModalVideoPlayer");
        if (video.requestFullscreen) {
            video.requestFullscreen();
        } else if (video.mozRequestFullScreen) { 
            video.mozRequestFullScreen();
        } else if (video.webkitRequestFullscreen) { 
            video.webkitRequestFullscreen();
        } else if (video.msRequestFullscreen) { 
            video.msRequestFullscreen();
        }
    }
    
    window.onbeforeunload = function() {
        const video = document.getElementById("inModalVideoPlayer");
        if (video && !video.paused && currentVideoUrl) {
            localStorage.setItem('videoProgress:' + currentVideoUrl, Math.floor(video.currentTime));
        }
    };
    // End Video Playback Functions


    // --- Other Functions (Unchanged) ---
    
    function showCategoriesOverlay(element) {
        document.querySelectorAll('.nav-item-btn').forEach(item => item.classList.remove('active'));
        if(element) element.classList.add('active');
        
        document.getElementById('categoriesOverlay').style.display = 'flex';
        loadCategoriesForOverlay();
    }
    
    function closeCategoriesOverlay() {
         document.getElementById('categoriesOverlay').style.display = 'none';
         const categoryBtn = document.querySelector('.nav-item-btn[data-target="categories"]');
         if(categoryBtn) categoryBtn.classList.remove('active');
    }

    function loadCategoriesForOverlay() {
        categoryRef.once('value', (snapshot) => {
            let categories = snapshot.val() || {};
            const categoryListDiv = document.getElementById('categoryListOverlay');
            categoryListDiv.innerHTML = '';

            const finalCategories = Object.keys(categories).length > 0 ? categories : defaultCategories;
            
            for (const key in finalCategories) {
                const name = finalCategories[key];
                const item = document.createElement('div');
                item.className = 'category-item-btn';
                item.innerText = name;
                item.onclick = function() {
                    handleNavClick(name, document.querySelector('.nav-item-btn[data-target="all"]'));
                    closeCategoriesOverlay(); 
                };
                categoryListDiv.appendChild(item);
            }
        });
    }

    // --- Data Fetching and Initialization (MODIFIED) ---
    async function loadAllContent() {
        spinner.style.display = 'block';
        grid.innerHTML = '';
        allContent = [];
        popularContent = [];

        try {
            // 1. Load Main Content (movies and series)
            const movieSnapshot = await moviesRef.once('value');
            movieSnapshot.forEach((childSnapshot) => {
                const content = childSnapshot.val();
                content.key = childSnapshot.key;
                content.type = content.type || (content.episodes ? 'series' : 'movie');
                
                if (!content.download) {
                    content.download = getRandomAdLink();
                }

                // Add all main content to allContent
                allContent.push(content);
            });
            
            // 2. Load Popular Content
            const popularSnapshot = await popularRef.once('value');
            popularSnapshot.forEach((childSnapshot) => {
                 const content = childSnapshot.val();
                 content.key = childSnapshot.key;
                 content.type = content.type || 'movie'; 
                 content.isPopular = true; // Ensure the flag is set
                 
                 if (!content.download) {
                    content.download = getRandomAdLink();
                 }
                 
                 // Add popular content to its separate array (for 'popular' tab)
                 popularContent.push(content);
                 
                 // ADD POPULAR CONTENT TO ALL CONTENT FOR 'ALL', 'MOVIE', 'SERIES' TABS
                 // Only add if it's not already there (based on key), though in Firebase RTDB popular_movies keys might differ.
                 // Assuming separate keys, we add them directly to allContent to make them available in other filters.
                 const isAlreadyInAllContent = allContent.some(item => item.key === content.key);
                 if (!isAlreadyInAllContent) {
                     allContent.push(content);
                 }
            });
            
            // Reverse both arrays to show newest first
            allContent.reverse(); 
            popularContent.reverse();

            spinner.style.display = 'none';
            handleNavClick('all', document.querySelector('.nav-item-btn[data-target="all"]'));
            
            console.log(`Content loaded: ${allContent.length} combined (standard + popular), ${popularContent.length} popular.`);

        } catch (error) {
            console.error("Error loading data from Firebase:", error);
            spinner.style.display = 'none';
            grid.innerHTML = `<p style="text-align: center; width: 100%; color: #ff4d4d;">Error loading content. Please check your Firebase configuration.</p>`;
        }
    }


    function debounceFilter() {
        clearTimeout(searchTimeout); 
        searchTimeout = setTimeout(searchMoviesAndRender, 300);
    }
    
    function searchMoviesAndRender() {
        const filterText = searchBar.value.trim().toUpperCase();
        
        if (filterText === '') {
            handleNavClick('all', document.querySelector('.nav-item-btn[data-target="all"]'));
            return;
        }

        currentFilterType = 'search';
        
        // Search in all available content
        filteredMovies = allContent.filter(movie => {
             return movie.title.toUpperCase().includes(filterText);
        });

        totalPages = Math.ceil(filteredMovies.length / MOVIES_PER_PAGE);
        currentPage = 1;
        renderPage(currentPage);

        document.querySelectorAll('.nav-item-btn').forEach(item => item.classList.remove('active'));
        paginationControls.style.display = 'none';
    }


    /**
     * Hides the ad popup and handles post-ad actions.
     */
    function hideAdPopup(isInitialLoad = true) {
        document.getElementById('adPopup').style.display = 'none';
        
        if (isInitialLoad) {
            console.log("Initial ad closed after timer expired.");
        } else {
            if (currentDetailMovieKey) {
                openDetail(currentDetailMovieKey); 
                // Scroll to the top of the detail modal
                const modalElement = document.getElementById("modal");
                if (modalElement) {
                    modalElement.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } else {
                 document.getElementById("modal").style.display = "block";
            }
        }
    }

    /**
     * Shows the ad popup with a specified link and duration.
     */
    function showAdPopup(url = getRandomAdLink(), duration = 20, isInitialLoad = true) { 
        if (!url || url === '#') {
            url = getRandomAdLink();
        }
        
        const adPopup = document.getElementById('adPopup');
        const adIframe = document.getElementById('adIframe');
        const adTimerSpan = document.getElementById('adTimer');
        
        if (!isInitialLoad) {
            document.getElementById("modal").style.display = "none";
        }

        adIframe.src = url;
        adPopup.style.display = 'flex';
        
        let timeLeft = duration; 
        adTimerSpan.innerText = timeLeft;

        const timer = setInterval(() => {
            timeLeft -= 1;
            adTimerSpan.innerText = timeLeft;

            if (timeLeft <= 0) {
                clearInterval(timer);
                hideAdPopup(isInitialLoad);
            }
        }, 1000);
    }
    
    // Initial Load Logic 
    window.onload = function() {
        loadAllContent(); 
        
        console.log("Page loaded. Content loading immediately. Starting 10-second delay before initial ad popup...");
        
        setTimeout(() => {
            showAdPopup(getRandomAdLink(), 20, true); 
        }, 10000); 
    };

</script>


</body>
</html>
